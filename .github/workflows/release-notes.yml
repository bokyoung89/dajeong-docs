name: Generate Release Notes
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for git log

      - name: Generate release notes
        run: |
          # Get version from swagger.yaml and remove potential quotes
          VERSION=$(grep 'version:' swagger.yaml | awk '{print $2}' | tr -d "'")

          # Prepare markdown content
          {
            echo -e "# 릴리즈 노트\n"
            echo -e "| 버전 | 날짜 | 변경이력 |"
            echo -e "|---|---|---|"
          } > docs/dajeong-api/current/release-notes.md

          # Get git log, filter it, and append to the markdown file as table rows
          # The format uses a pipe separator for easy parsing in the while loop
          git log --pretty=format:'%ad|%s' --date=format:'%Y-%m-%d' --grep="docs: Re-generate API docs" --invert-grep | while IFS='|' read -r GDATE GMSG; do
            echo "| $VERSION | $GDATE | $GMSG |" >> docs/dajeong-api/current/release-notes.md
          done

      - name: Commit and push if release notes changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/dajeong-api/current/release-notes.md
          if ! git diff --staged --quiet; then
            git commit -m "docs: Update release notes"
            git push
          else
            echo "No changes to commit for release notes"
          fi